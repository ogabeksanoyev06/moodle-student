"use strict";(self["webpackChunkmoodle_student"]=self["webpackChunkmoodle_student"]||[]).push([[973],{4600:function(e,t,s){s.r(t),s.d(t,{default:function(){return u}});var a=function(){var e=this,t=e._self._c;return t("section",[t("div",{staticClass:"test"},[t("div",{staticClass:"test_left"},[t("canvas",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],attrs:{width:"500",height:"500",id:"fake"}}),t("video",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],ref:"video",attrs:{width:"640",height:"480",autoplay:""}}),t("canvas",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],ref:"canvas",attrs:{width:"640",height:"480"}}),t("img",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],ref:"faceImage",attrs:{id:"faceImage",alt:"Face Image"}}),t("div",{ref:"testBody",staticClass:"test_body"},[t("div",{staticClass:"test_subject"},e._l(e.questions,(function(s,a){return t("div",{key:a,ref:"question_"+a,refInFor:!0,staticClass:"test_question"},[t("div",{staticClass:"test_question-title pt-1"},[t("AppText",{attrs:{size:16,weight:600}},[t("span",{domProps:{innerHTML:e._s(s.name)}})])],1),t("ul",{staticClass:"test_answers pb-1"},e._l(s.answers,(function(a,i){return t("li",{key:i,class:a.is_selected?"test_answers-title active":"test_answers-title",on:{click:function(t){return e.selectAnswer(s.id,a.id)}}},[t("AppText",{staticClass:"mr-1",attrs:{size:e.isMobile?14:16,"line-height":e.isMobile?20:24,weight:"600"}},[e._v(" "+e._s(e.answerLabels[i]+")")+" ")]),t("AppText",{attrs:{size:(e.isMobile,14),"line-height":e.isMobile?20:24,weight:"500"}},[t("span",{domProps:{innerHTML:e._s(a.name)}})])],1)})),0)])})),0)])]),t("div",{staticClass:"test_right"},[t("div",{staticClass:"test_pagination-top"},[t("span",{staticStyle:{"font-size":"1.7rem","max-width":"200px",border:"1px solid #00b74a",color:"#00b74a",padding:"0 10px"}},[e._v(" "+e._s(e.timerFormat(e.testTimer))+" ")]),t("button",{staticClass:"btn btn-danger",staticStyle:{width:"fit-content !important"},on:{click:e.checkLogOut1}},[e._v(" Yopish ")])]),t("ul",{staticClass:"test_pagination"},e._l(e.questions,(function(s,a){return t("li",{key:a,class:s.is_selected?"test_pagination-item active":"test_pagination-item",on:{click:function(t){return e.scrollToQuestion(a)}}},[e._v(" "+e._s(a+1)+" ")])})),0),t("div",{staticClass:"test_pagination-bottom"},[t("button",{on:{click:e.showModalClick}},[e._v("Yakunlash")])])])]),t("AppModal",{class:{visible:e.showModal},attrs:{width:300},on:{close:e.closeModal},scopedSlots:e._u([{key:"modalHeader",fn:function(){return[e._v(" Testni yakunlamoqchimisiz ?")]},proxy:!0},{key:"modalBody",fn:function(){return[t("div",{staticClass:"buttons",on:{click:e.closeModal}},[t("button",{staticClass:"btn btn-danger"},[e._v("Yo'q")]),t("button",{staticClass:"btn btn-success",on:{click:e.finishTest}},[e._v("Ha")])])]},proxy:!0}])}),t("div",{staticClass:"overlay",class:{visible:e.showModal},on:{click:e.closeModal}})],1)},i=[],n=(s(7658),s(7592)),o=s(3822),r=s(166),c={components:{AppModal:n.Z},name:"AppTest",data(){return{questions:[],select:[],exam_id:"",exam_detail:null,ip_address:"",student_id:"",answerLabels:["A","B","C","D","E","F","G","H"],testTimer:0,activeP:0,showModal:!1,screenStream:null,isScreenSharing:!1,isStartStream:!1,isPageInFocus:!0,videoStream:null}},methods:{...(0,o.nv)(["getUser"]),scrollToQuestion(e){const t=this.$refs["question_"+e][0];t&&t.scrollIntoView({behavior:"smooth"}),this.activeP=e},async getExamTest(){this.loading=!0,await this.$http.post("test/begin/",{exam:this.exam_id,ip_address:this.ip_address,student:this.student_id}).then((e=>{e.forEach((e=>{let t={id:e.id,name:e.name,answers:e.answers.map((e=>({...e,is_selected:!1}))),is_selected:!1};this.questions.push(t)}))})).catch((e=>{this.notificationMessage(e.response.data.message,"error")})).finally((()=>{this.loading=!1}))},async resultCreate(){const e={exam:this.exam_id,student:this.student_id,group:this.user.group.id,ip_address:this.ip_address,attempts:this.exam_detail.attempts,total_count:this.exam_detail.total_count,max_score:this.exam_detail.max_score,is_start:!0,exam_time:this.exam_detail.exam_time};await this.$http.post("result/create",e).then((e=>{console.log("res",e),this.testTimer=Math.abs(e.exam_time_second)})).catch((e=>{if(e.response&&e.response.data){const t=e.response.data;for(const e in t)if(Object.hasOwnProperty.call(t,e)){const s=t[e];this.notificationMessage(`${e}: ${s.join(", ")}`,"error")}}})).finally((()=>{}))},getDefault(){this.$http.get(`student-select-answers-get/${this.exam_id}/for/${this.student_id}/`).then((e=>{this.select=e.data,this.collectSelect()})).catch((e=>{console.log(e)}))},async getExamDetail(){await this.$http.get(`exam-detail/${this.exam_id}`).then((e=>{this.exam_detail=e})).catch((()=>{})).finally((()=>{}))},setTimer(){let e=this,t=setInterval((function(){if(e.testTimer/60<=0)return e.finishTest(),void clearInterval(t);e.testTimer--}),1e3)},timerFormat(e){let t=parseInt(e,10),s=Math.floor(t/3600),a=Math.floor((t-3600*s)/60),i=t-3600*s-60*a;return s<10&&(s="0"+s),a<10&&(a="0"+a),i<10&&(i="0"+i),s+":"+a+":"+i},async fetchLocalIPAddress(){try{const e=await this.getIPAddressViaWebRTC();if(e)return e;const t=await this.getIPAddressViaService();return t||null}catch(e){return console.error("Error fetching local IP address:",e),null}},async getIPAddressViaWebRTC(){return new Promise((e=>{window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;const t=new RTCPeerConnection;t.createDataChannel(""),t.createOffer().then((e=>{t.setLocalDescription(e)})),t.onicecandidate=s=>{if(s&&s.candidate&&s.candidate.candidate){const t=/\d+\.\d+\.\d+\.\d+/,a=t.exec(s.candidate.candidate);if(a){const t=a[0];e(t)}}t.onicecandidate=null,t.close()}}))},async getIPAddressViaService(){try{const e=await fetch("https://api.ipify.org?format=json"),t=await e.json();return t.ip}catch(e){return console.error("Error fetching IP address via service:",e),null}},stopScreenSharing(){if(this.screenStream){const e=this.screenStream.getTracks();e.forEach((e=>e.stop())),this.isStartStream=!1,console.log("Screen sharing stream stopped")}},selectAnswer(e,t){this.fetchLocalIPAddress().then((e=>{this.ip_address=e})),this.$http.patch(`student-exam-answers/${this.exam_id}/for/${this.student_id}/`,{question:e,is_selected:t,ip_address:this.ip_address}).then((e=>{this.select=e,this.collectSelect(),console.log(this.questions),console.log(e)})).catch((e=>{console.log(e)})).finally((()=>{}))},collectSelect(){this.select.forEach((e=>{const t=e.question,s=e.is_selected,a=this.questions.find((e=>e.id===t));if(a){a.is_selected=!0,a.answers.forEach((e=>{e.is_selected=!1}));const e=a.answers.find((e=>e.id===s));e&&(e.is_selected=!0)}}))},finishTest(){this.$http.get(`exam-finish/${this.exam_id}/finish/${this.student_id}/`).then((()=>{this.$router.push({name:"test-exams"})})).catch((e=>{console.log(e)}))},closeModal(){this.showModal=!1,document.body.style.overflowY="scroll"},showModalClick(){this.showModal=!0,document.body.style.overflowY="hidden"},checkLogOut1(){this.$http.post("check-logout/",{exam:this.exam_id,student:this.student_id}).then((()=>{this.$router.push({name:"test-exams"})})).catch((()=>{}))},checkLogOut2(){this.$http.post("check-logout/",{exam:this.exam_id,student:this.student_id}).then((()=>{})).catch((()=>{}))},handleBeforeUnload(e){const t={exam:this.exam_id,student:this.student_id},s=new Blob([JSON.stringify(t)],{type:"application/json"});if(navigator.sendBeacon("https://api.fastlms.uz/api/check-logout/",s),e.preventDefault(),this.isStartStream){const t="You are currently screen sharing. Are you sure you want to leave?";return e.returnValue=t,t}},async startScreenSharing(){try{const e={video:{mediaSource:"screen",displaySurface:"monitor"}};navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia(e).then((e=>{e.addEventListener("inactive",(()=>{this.isStartStream=!1,console.log("Screen capture stream has stopped")})),this.isStartStream=!0,this.screenStream=e,this.enterFullscreen()})).catch((e=>{console.log(e)})):navigator.getDisplayMedia(e).then((e=>{e.addEventListener("inactive",(()=>{this.isStartStream=!1,console.log("Screen capture stream has stopped")})),this.isStartStream=!0,this.screenStream=e,this.enterFullscreen()})).catch((e=>{console.log(e)})),window.addEventListener("beforeunload",this.handleBeforeUnload)}catch(e){console.error("Error accessing screen:",e.message||e)}},async takeScreenShot(){try{const e=this.screenStream.getVideoTracks()[0],t=new ImageCapture(e),s=await t.grabFrame(),a=document.getElementById("fake");a.width=s.width,a.height=s.height;const i=a.getContext("2d");i.drawImage(s,0,0,s.width,s.height);const n=a.toDataURL(),o=await fetch(n),r=await o.arrayBuffer(),c=[new File([r],`photo_${new Date}.jpg`,{type:"image/jpeg"})];console.log(c)}catch(e){console.error("Error taking screenshot:",e.message||e)}},checkPageFocus(){const e=document.hasFocus();e||this.hasTakenScreenshot||!this.isStartStream?e&&this.hasTakenScreenshot&&this.isStartStream&&(console.log("Page has regained focus. Taking screenshot..."),this.hasTakenScreenshot=!1):(console.log("Page has lost focus. Taking screenshot..."),this.takeScreenShot(),this.hasTakenScreenshot=!0),this.isPageInFocus=e,this.isPageInFocus=document.hasFocus()},async startVideo(){try{const e=this.$refs.video,t=this.$refs.canvas;let s=!1;await Promise.all([r.qB.tinyFaceDetector.loadFromUri("/models"),r.qB.faceLandmark68Net.loadFromUri("/models"),r.qB.faceRecognitionNet.loadFromUri("/models"),r.qB.faceExpressionNet.loadFromUri("/models")]),e.srcObject=await navigator.mediaDevices.getUserMedia({video:{}}),this.videoStream=e.srcObject,e.addEventListener("play",(async()=>{const a={width:e.width,height:e.height};r.JF(t,a),setInterval((async()=>{const i=await r.Qr(e,new r.aK).withFaceLandmarks().withFaceDescriptors(),n=r._C(i,a),o=t.getContext("2d");o.clearRect(0,0,t.width,t.height),i.length<=0?(r.ii.drawDetections(t,n),r.ii.drawFaceLandmarks(t,n),s||(s=!0)):s=!1}),100)}))}catch(e){console.error("Error accessing webcam:",e)}},captureVideoFrame(e,t){const s=t.getContext("2d");return s.drawImage(e,0,0,t.width,t.height),t.toDataURL("image/png")},handleResize(){this.takeScreenShot()},stopVideo(){if(this.videoStream){const e=this.videoStream.getTracks();e.forEach((e=>e.stop()))}}},beforeDestroy(){window.removeEventListener("beforeunload",this.handleBeforeUnload),this.checkLogOut2(),this.stopVideo(),this.stopScreenSharing()},computed:{...(0,o.Se)(["user"])},async mounted(){this.isScreenSharing||this.startScreenSharing(),await this.startVideo(),this.focusInterval=setInterval(this.checkPageFocus,500),this.checkPageFocus(),window.addEventListener("resize",this.handleResize),window.addEventListener("beforeunload",this.handleBeforeUnload),this.fetchLocalIPAddress().then((e=>{this.ip_address=e})),await this.getUser(),await this.getExamDetail(),await this.resultCreate(),await this.getExamTest(),this.setTimer(),this.getDefault()},created(){this.exam_id=this.$route.params.exam_id,this.student_id=localStorage.getItem("student_id")}},h=c,d=s(1001),l=(0,d.Z)(h,a,i,!1,null,"2f5bc65f",null),u=l.exports}}]);
//# sourceMappingURL=973.f8337f4e.js.map